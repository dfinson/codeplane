name: Integration Tests

on:
  # Manual trigger with optional private repo testing
  workflow_dispatch:
    inputs:
      include_private:
        description: 'Include private repo tests'
        required: false
        default: 'true'
        type: boolean
  # Run nightly to catch external changes
  schedule:
    - cron: '0 6 * * *'  # 6 AM UTC daily

permissions:
  contents: read

jobs:
  integration:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Configure git identity
        run: |
          git config --global user.email "ci@codeplane.dev"
          git config --global user.name "CodePlane CI"

      # Generate ephemeral token for private repo access
      # Requires: CODEPLANE_TEST_APP_ID and CODEPLANE_TEST_APP_PRIVATE_KEY secrets
      - name: Generate GitHub App token
        id: app-token
        if: |
          (github.event_name != 'workflow_dispatch' || inputs.include_private) &&
          vars.CODEPLANE_TEST_APP_ID != ''
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.CODEPLANE_TEST_APP_ID }}
          private-key: ${{ secrets.CODEPLANE_TEST_APP_PRIVATE_KEY }}
          repositories: codeplane-test-private
          owner: dfinson
        continue-on-error: true

      - name: Configure git credentials for private repo
        if: steps.app-token.outputs.token != ''
        run: |
          git config --global credential.helper store
          echo "https://x-access-token:${{ steps.app-token.outputs.token }}@github.com" >> ~/.git-credentials

      - name: Run integration tests
        env:
          CODEPLANE_TEST_PRIVATE_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          pytest tests/integration -v -m "integration" --tb=short

      - name: Report results
        if: always()
        run: |
          if [ -n "${{ steps.app-token.outputs.token }}" ]; then
            echo "✅ Private repo tests: included"
          else
            echo "⚠️ Private repo tests: skipped (no credentials)"
          fi
