name: "CI"
permissions:
  contents: read
  pull-requests: read

on:
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  spell-check:
    name: Spell Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Spell Check
        uses: streetsidesoftware/cspell-action@v8
        with:
          config: './cspell.config.yaml'
          verbose: true

      - name: Show Spell Check Results
        uses: streetsidesoftware/actions/public/summary@v1
        with:
          text: |
            outputs:
            ```json
            ${{ toJSON(steps.cspell-action.outputs) }}
            ```

  checkov-security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          persist-credentials: false
      
      - name: Run Checkov Security Scan
        id: checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          output_format: cli
          soft_fail: false

  lint-and-build:
    name: Lint and Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false
    
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Ruff Lint
        uses: astral-sh/ruff-action@v3

      - name: Ruff Format
        uses: astral-sh/ruff-action@v3
        with:
          args: "format --check"
      
      - name: Install uv
        uses: astral-sh/setup-uv@v7
      
      - name: Build wheel
        run: make build
  
  test:
    needs: lint-and-build
    name: Test ${{ matrix.backend }} (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.12', '3.13']
        backend: ['core', 'mlflow', 'azureml']
        include:
          - backend: core
            test_path: tests/evee tests/github_scripts
            cov_path: src/evee .github/tools
          - backend: mlflow
            test_path: packages/evee-mlflow/tests
            cov_path: packages/evee-mlflow/src
          - backend: azureml
            test_path: packages/evee-azureml/tests
            cov_path: packages/evee-azureml/src
    permissions:
      contents: read
      pull-requests: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        persist-credentials: false

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '${{ matrix.python-version }}'

    - name: Install uv
      uses: astral-sh/setup-uv@v7

    - name: Install dependencies
      run: |
        uv venv
        source .venv/bin/activate
        uv pip install -e ".[dev]"
        if [ "${{ matrix.backend }}" = "mlflow" ]; then
          uv pip install -e "packages/evee-mlflow"
        elif [ "${{ matrix.backend }}" = "azureml" ]; then
          uv pip install -e "packages/evee-azureml"
        fi
      shell: bash

    - name: Run tests with coverage
      env:
        COVERAGE_FILE: .coverage
      run: uv run pytest ${{ matrix.test_path }} --cov=${{ matrix.cov_path }} --cov-report=term
      shell: bash

    - name: Rename coverage file
      if: always()
      run: |
        test -f .coverage && mv .coverage .coverage-${{ matrix.backend }} || true

    - name: Upload coverage artifact
      # Only upload from 3.12 - coverage is version-independent, avoid duplicates
      if: matrix.python-version == '3.12'
      uses: actions/upload-artifact@v6
      with:
        name: coverage-${{ matrix.backend }}
        path: .coverage-${{ matrix.backend }}
        include-hidden-files: true

  coverage-report:
    name: Coverage Report
    needs: [test]
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Download all coverage artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: coverage-*
          path: coverage-files
          merge-multiple: true

      - name: Merge coverage reports
        run: |
          pip install coverage
          cp coverage-files/.coverage-* .
          COVERAGE_FILE=.coverage coverage combine .coverage-*
          coverage xml -o coverage.xml
          coverage report --show-missing

      - name: Comment PR with Coverage
        uses: py-cov-action/python-coverage-comment-action@v3.40
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MINIMUM_GREEN: 85
          MINIMUM_ORANGE: 70

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    # Only runs on PRs - requires base/head refs to compare dependency changes
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v6
        with:
          persist-credentials: false
      
      - name: 'Dependency Review'
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: low
          comment-summary-in-pr: on-failure
          allow-licenses: MIT, Apache-2.0, BSD-3-Clause

  devcontainer-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false
          fetch-depth: 0
      
      - name: Install DevContainer CLI
        run: npm install -g @devcontainers/cli
      
      - name: Build and start DevContainer
        run: devcontainer up --workspace-folder . --config .devcontainer/devcontainer.json
      
      - name: Verify post-create script success
        run: |
          devcontainer exec --workspace-folder . --config .devcontainer/devcontainer.json grep -F "âœ… Post-create script completed successfully." /tmp/post_create.log
      
      - name: Verify pre-commit installation
        run: devcontainer exec --workspace-folder . --config .devcontainer/devcontainer.json pre-commit --version
      
      - name: Verify uv installation
        run: devcontainer exec --workspace-folder . --config .devcontainer/devcontainer.json uv --version
      
      - name: Verify Python installation
        run: devcontainer exec --workspace-folder . --config .devcontainer/devcontainer.json python --version
